name: FXD Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-node:
    name: Node.js Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run unit tests
      run: npm run test

    - name: Run integration tests
      run: npm run test:integration

    - name: Run performance benchmarks
      run: npm run test:performance

    - name: Generate coverage report
      run: |
        npm run test:coverage
        node test-node/coverage/coverage-reporter.js ./coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        fail_ci_if_error: true

    - name: Upload coverage reports as artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports-node-${{ matrix.node-version }}
        path: ./coverage/

  test-deno:
    name: Deno Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v1.x

    - name: Run Deno tests
      run: deno test -A test/

    - name: Check Deno formatting
      run: deno fmt --check

    - name: Run Deno linter
      run: deno lint

  test-ui:
    name: UI Tests (Puppeteer)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Chrome dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser

    - name: Run UI tests
      run: npm run test:ui
      env:
        PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium-browser

    - name: Upload UI test screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: ui-test-screenshots
        path: ./test-screenshots/

  test-sqlite:
    name: SQLite Persistence Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run SQLite tests
      run: npm run test:sqlite

    - name: Test with large dataset
      run: npm run test:sqlite -- --large-dataset

    - name: Stress test database operations
      run: npm run test:sqlite -- --stress-test

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level moderate

    - name: Run dependency check
      run: |
        npx audit-ci --moderate
        npx license-checker --summary

  build-and-package:
    name: Build and Package
    runs-on: ubuntu-latest
    needs: [test-node, test-deno, test-ui, test-sqlite]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build

    - name: Package for distribution
      run: npm pack

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fxd-package
        path: |
          *.tgz
          dist/

  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: [test-node, test-deno, test-ui, test-sqlite]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download coverage reports
      uses: actions/download-artifact@v4
      with:
        name: coverage-reports-node-20.x
        path: ./coverage

    - name: Check coverage thresholds
      run: |
        node -e "
          const fs = require('fs');
          const coverage = JSON.parse(fs.readFileSync('./coverage/coverage.json', 'utf8'));
          const { lines, functions, branches } = coverage.coverage.summary;

          const thresholds = { lines: 80, functions: 80, branches: 70 };
          const failures = [];

          if (lines.percentage < thresholds.lines) failures.push(\`Lines: \${lines.percentage}% < \${thresholds.lines}%\`);
          if (functions.percentage < thresholds.functions) failures.push(\`Functions: \${functions.percentage}% < \${thresholds.functions}%\`);
          if (branches.percentage < thresholds.branches) failures.push(\`Branches: \${branches.percentage}% < \${thresholds.branches}%\`);

          if (failures.length > 0) {
            console.error('‚ùå Coverage thresholds not met:');
            failures.forEach(f => console.error('  -', f));
            process.exit(1);
          }

          console.log('‚úÖ All coverage thresholds met!');
        "

    - name: Check test stability
      run: |
        node -e "
          const fs = require('fs');
          const coverage = JSON.parse(fs.readFileSync('./coverage/coverage.json', 'utf8'));
          const { failed, total, passRate } = coverage.tests.summary;

          if (failed > 0) {
            console.error(\`‚ùå \${failed} tests failed out of \${total}\`);
            process.exit(1);
          }

          if (passRate < 100) {
            console.error(\`‚ùå Pass rate \${passRate}% is below 100%\`);
            process.exit(1);
          }

          console.log('‚úÖ All tests passed!');
        "

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [quality-gates, build-and-package]
    if: always()

    steps:
    - name: Notify success
      if: success()
      run: |
        echo "üéâ All FXD tests and quality gates passed!"
        echo "The build is ready for deployment."

    - name: Notify failure
      if: failure()
      run: |
        echo "‚ùå FXD test suite failed!"
        echo "Please check the logs and fix the issues before merging."